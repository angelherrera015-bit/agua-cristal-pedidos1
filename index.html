<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AGUA CRISTAL ZONA 6 - Pedidos</title>
    <!-- Carga de Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Carga de √≠conos Lucide para React (usados aqu√≠ como iconos generales) -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* Estilos personalizados para la paleta azul agua */
        :root {
            --color-primary: #06b6d4; /* Tailwind cyan-500 */
            --color-secondary: #0891b2; /* Tailwind cyan-600 */
            --color-light: #f0fdfa; /* Tailwind cyan-50 */
            --color-dark: #0e7490; /* Tailwind cyan-700 */
        }
        .bg-water-primary { background-color: var(--color-primary); }
        .hover\:bg-water-secondary:hover { background-color: var(--color-secondary); }
        .text-water-primary { color: var(--color-primary); }
        .border-water-primary { border-color: var(--color-primary); }
        .shadow-water { box-shadow: 0 10px 15px -3px rgba(6, 182, 212, 0.5), 0 4px 6px -2px rgba(6, 182, 212, 0.05); }

        body { font-family: 'Inter', sans-serif; background-color: var(--color-light); }

        /* Estilo para los botones principales */
        .main-button {
            transition: all 0.3s ease;
            transform: scale(1);
        }
        .main-button:hover {
            transform: scale(1.03);
            box-shadow: 0 20px 25px -5px rgba(6, 182, 212, 0.4);
        }

        /* Estilo para el bot√≥n de WhatsApp */
        .whatsapp-button {
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px -1px rgba(34, 197, 94, 0.1), 0 2px 4px -2px rgba(34, 197, 94, 0.06);
        }
        .whatsapp-button:hover {
            background-color: #16a34a; /* green-600 */
            transform: translateY(-1px);
        }
    </style>
</head>
<body class="min-h-screen flex flex-col antialiased">

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setLogLevel, addDoc, onSnapshot, collection, query, updateDoc, deleteDoc, getDocs, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global Firebase and App variables
        let app, db, auth;
        let userId = 'anon';
        let userRole = null; // 'ADMINISTRADOR' or 'USUARIO 1'
        let currentView = 'login';
        let dailySales = 0;
        let todayOrders = [];
        let isFirestoreAvailable = true; 

        // --- PRECIOS ---
        const PRECIO_DOMICILIO = 10.00;
        const PRECIO_FISICA = 9.00;

        // --- ROLES y CREDENCIALES (Hardcoded para simulaci√≥n) ---
        const CREDENTIALS = {
            'ADMINISTRADOR': 'Angel2006$',
            'USUARIO 1': 'Aguacristal06'
        };

        // =================================================================================
        // BLOQUE DE CONFIGURACI√ìN DE FIREBASE
        // =================================================================================
        const APP_ID = "aguacristal-3668c"; 

        const FIREBASE_CONFIG = {
            apiKey: "AIzaSyAlrX-AEX7P-Ntpg30_62YHbL6Z3zxykDQ",
            authDomain: "aguacristal-3668c.firebaseapp.com",
            projectId: "aguacristal-3668c",
            storageBucket: "aguacristal-3668c.firebasestorage.app",
            messagingSenderId: "777148704166",
            appId: "1:777148704166:web:c522eaac1d469ac0829b67"
        };
        // =================================================================================
        
        // --- RUTAS DE COLECCI√ìN ---
        const ORDERS_COLLECTION = `orders_ACZ6`;
        const CUSTOMERS_COLLECTION = `customers_ACZ6`; // Nueva colecci√≥n para el CRM

        // Utility: Get date in YYYY-MM-DD format
        const getTodayDate = () => new Date().toISOString().slice(0, 10);
        // Utility: Sanitizes phone number to digits only, used as customer ID in DB
        const sanitizePhone = (phone) => phone.replace(/[^0-9]/g, '');


        // --- FIREBASE INITIALIZATION AND AUTH ---
        window.initFirebase = async () => {
            const loadingMessageElement = document.getElementById('loading-message');

            try {
                setLogLevel('debug');
                app = initializeApp(FIREBASE_CONFIG);
                db = getFirestore(app);
                auth = getAuth(app);
                isFirestoreAvailable = true; 

                // Intentamos iniciar sesi√≥n an√≥nimamente para obtener un UID.
                try {
                    await new Promise(resolve => {
                        onAuthStateChanged(auth, async (user) => {
                            if (user) {
                                userId = user.uid;
                                console.log("Firebase Auth successful. User ID:", userId);
                            } else {
                                await signInAnonymously(auth);
                            }
                            resolve();
                        });
                    });
                } catch (authError) {
                    console.error("Firebase Auth Error: Could not sign in anonymously. User ID set to 'anon'.", authError);
                    userId = 'anon';
                }

                // Start listening to orders
                window.setupRealtimeListener();

                // Initial UI rendering
                window.renderApp();

            } catch (error) {
                console.error("Error during Firebase initialization:", error);
                loadingMessageElement.textContent = `Error cr√≠tico de Firebase: No se pudo conectar a la DB. (${error.message})`;
                isFirestoreAvailable = false; 
                window.renderApp('login'); 
            }
        };

        // --- STATE MANAGEMENT AND RENDERING ---
        window.renderApp = (newView = currentView) => {
            currentView = newView;
            const appContainer = document.getElementById('app-container');
            const isAdmin = userRole === 'ADMINISTRADOR';

            // Clear container
            appContainer.innerHTML = '';

            // Render based on the current view
            let content = '';

            if (!userRole) {
                content = window.renderLogin();
            } else if (currentView === 'home') {
                content = window.renderHome();
            } else if (currentView === 'form') {
                content = window.renderOrderForm();
            } else if (currentView === 'orders') {
                content = window.renderOrdersList(isAdmin);
            }

            appContainer.innerHTML = content;
            lucide.createIcons(); // Initialize Lucide icons
            window.attachEventListeners();

            // FIX: Populate the orders table immediately if the user is viewing the list,
            // using the data already fetched by the real-time listener.
            if (currentView === 'orders') {
                window.updateOrdersTable(todayOrders);
            }

            // Display DB status notification if not available (only on connection failure)
            if (!isFirestoreAvailable && currentView !== 'login') {
                 const statusDiv = document.createElement('div');
                 statusDiv.className = 'fixed top-0 left-0 right-0 bg-red-400 text-white p-2 text-center font-semibold text-sm z-50';
                 statusDiv.textContent = '‚ùå ERROR: La conexi√≥n a Firebase fall√≥. No se guardar√°n los pedidos.';
                 document.body.appendChild(statusDiv);
            }
        };

        window.renderLogin = () => {
            return `
                <div id="login-screen" class="p-8 max-w-sm mx-auto my-16 bg-white rounded-xl shadow-water border-4 border-water-primary">
                    <h1 class="text-3xl font-extrabold text-center mb-4 text-water-primary">AGUA CRISTAL ZONA 6</h1>
                    <p class="text-center text-sm text-gray-500 mb-6">Inicia Sesi√≥n para Continuar</p>
                    <div id="login-error" class="text-red-600 text-center mb-4 font-semibold hidden"></div>

                    <div class="space-y-4">
                        <div>
                            <label for="username" class="block text-sm font-medium text-gray-700">Usuario (ADMINISTRADOR o USUARIO 1)</label>
                            <input type="text" id="username" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-water-primary focus:border-water-primary sm:text-sm" placeholder="ADMINISTRADOR o USUARIO 1" value="">
                        </div>
                        <div>
                            <label for="password" class="block text-sm font-medium text-gray-700">Contrase√±a</label>
                            <input type="password" id="password" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-water-primary focus:border-water-primary sm:text-sm">
                        </div>
                        <button id="login-button" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-lg font-medium text-white bg-water-primary hover:bg-water-secondary focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-water-primary transition duration-150 ease-in-out">
                            Ingresar
                        </button>
                    </div>
                </div>
            `;
        };

        window.renderHome = () => {
            return `
                <header class="w-full bg-white shadow p-4 flex justify-between items-center sticky top-0 z-10">
                    <h1 class="text-xl font-bold text-water-dark">Bienvenido, ${userRole}</h1>
                    <div class="flex items-center space-x-4">
                        <button id="view-orders-button" class="flex items-center px-4 py-2 text-sm font-medium rounded-full bg-cyan-100 text-water-dark hover:bg-cyan-200 transition">
                            <i data-lucide="list-ordered" class="w-4 h-4 mr-2"></i> Ver Pedidos
                        </button>
                        <button id="logout-button" class="flex items-center px-4 py-2 text-sm font-medium rounded-full bg-red-100 text-red-700 hover:bg-red-200 transition">
                            <i data-lucide="log-out" class="w-4 h-4 mr-2"></i> Salir
                        </button>
                    </div>
                </header>
                <div class="flex-grow flex flex-col justify-center items-center p-6 space-y-8 max-w-4xl mx-auto">
                    <h2 class="text-4xl font-extrabold text-gray-800 text-center mb-6">Selecciona el Tipo de Pedido</h2>

                    <div class="grid md:grid-cols-2 gap-8 w-full">
                        <button id="order-domicilio" data-type="A DOMICILIO" class="main-button flex flex-col items-center justify-center p-10 bg-white rounded-2xl shadow-water text-water-dark border-4 border-water-primary">
                            <i data-lucide="truck" class="w-16 h-16 mb-4"></i>
                            <span class="text-2xl font-bold">A DOMICILIO</span>
                            <span class="text-sm mt-1 text-gray-500">Q.${PRECIO_DOMICILIO.toFixed(2)} por Garraf√≥n</span>
                        </button>

                        <button id="order-fisica" data-type="ENTREGA F√çSICA" class="main-button flex flex-col items-center justify-center p-10 bg-white rounded-2xl shadow-water text-water-dark border-4 border-water-primary">
                            <i data-lucide="store" class="w-16 h-16 mb-4"></i>
                            <span class="text-2xl font-bold">ENTREGA F√çSICA</span>
                            <span class="text-sm mt-1 text-gray-500">Q.${PRECIO_FISICA.toFixed(2)} por Garraf√≥n</span>
                        </button>
                    </div>
                </div>
            `;
        };

        window.renderOrderForm = (orderType = null) => {
            // Retrieve type from localStorage if needed (e.g., after a reload)
            const type = orderType || localStorage.getItem('currentOrderType');
            if (!type) {
                setTimeout(() => window.renderApp('home'), 0);
                return 'Cargando...';
            }

            const isDomicilio = type === 'A DOMICILIO';
            const price = isDomicilio ? PRECIO_DOMICILIO : PRECIO_FISICA;
            const priceText = `Q.${price.toFixed(2)} / Garraf√≥n`;

            return `
                <div class="p-6 max-w-2xl mx-auto my-8 bg-white rounded-xl shadow-lg border-t-8 border-water-primary">
                    <button id="back-home-button" class="mb-4 text-gray-500 hover:text-water-primary flex items-center transition">
                        <i data-lucide="chevron-left" class="w-5 h-5 mr-1"></i> Volver al Inicio
                    </button>
                    <h2 class="text-2xl font-bold text-gray-800 mb-1">Nuevo Pedido:</h2>
                    <h3 class="text-3xl font-extrabold text-water-dark mb-6">${type} <span class="text-xl text-gray-500 ml-3">(${priceText})</span></h3>

                    <form id="order-form" class="space-y-4">
                        <!-- Tel√©fono del Cliente (Clave para Autocompletado) -->
                        <div>
                            <label for="phone" class="block text-sm font-medium text-gray-700">2. Tel√©fono del Cliente</label>
                            <div class="relative">
                                <input type="tel" id="phone" required class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-water-primary focus:border-water-primary font-bold" placeholder="Ej: 55112233">
                                <span id="autocomplete-status" class="absolute right-3 top-3 text-xs text-gray-500"></span>
                            </div>
                        </div>

                        <!-- Nombre del Cliente -->
                        <div>
                            <label for="customerName" class="block text-sm font-medium text-gray-700">1. Nombre del Cliente</label>
                            <input type="text" id="customerName" required class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-water-primary focus:border-water-primary">
                        </div>

                        <!-- Cantidad de Garrafones -->
                        <div class="flex items-end space-x-4">
                            <div class="flex-1">
                                <label for="quantity" class="block text-sm font-medium text-gray-700">3. Cantidad de Garrafones (1-9)</label>
                                <input type="number" id="quantity" min="1" max="9" value="1" required class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm text-center focus:ring-water-primary focus:border-water-primary">
                            </div>
                            <div class="flex-1 p-2 bg-cyan-50 rounded-lg border border-cyan-200 text-center">
                                <span class="text-xs font-semibold text-gray-600">Total:</span>
                                <p id="total-display" class="text-2xl font-extrabold text-water-dark">Q.${price.toFixed(2)}</p>
                            </div>
                        </div>

                        <!-- NIT (Opcional) -->
                        <div>
                            <label for="nit" class="block text-sm font-medium text-gray-700">4. NIT (Opcional)</label>
                            <input type="text" id="nit" class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-water-primary focus:border-water-primary">
                        </div>

                        <!-- Direcci√≥n (Solo si es A DOMICILIO) -->
                        <div id="address-container" class="${isDomicilio ? '' : 'hidden'}">
                            <label for="address" class="block text-sm font-medium text-gray-700">5. Direcci√≥n de Entrega</label>
                            <textarea id="address" rows="3" ${isDomicilio ? 'required' : ''} class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-water-primary focus:border-water-primary"></textarea>
                        </div>

                        <!-- Bot√≥n de Registro -->
                        <button type="submit" class="w-full flex justify-center py-3 px-4 border border-transparent rounded-lg shadow-lg text-xl font-bold text-white bg-water-primary hover:bg-water-secondary focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-water-primary transition duration-150 ease-in-out mt-6">
                            <i data-lucide="save" class="w-6 h-6 mr-2"></i> REGISTRAR PEDIDO
                        </button>
                    </form>

                    <div id="form-message" class="mt-4 p-3 rounded-lg text-center hidden"></div>
                </div>
            `;
        };

        window.renderOrdersList = (isAdmin) => {
            const today = getTodayDate();
            const todaySales = dailySales.toFixed(2);
            const todayCount = todayOrders.length;

            return `
                <header class="w-full bg-white shadow p-4 flex justify-between items-center sticky top-0 z-10">
                    <h1 class="text-xl font-bold text-water-dark">Control de Pedidos</h1>
                    <div class="flex items-center space-x-4">
                        ${isAdmin ? `
                            <button id="export-csv-button" class="flex items-center px-4 py-2 text-sm font-medium rounded-full bg-green-100 text-green-700 hover:bg-green-200 transition">
                                <i data-lucide="file-text" class="w-4 h-4 mr-2"></i> Exportar CSV
                            </button>
                        ` : ''}
                        <button id="back-home-button-orders" class="flex items-center px-4 py-2 text-sm font-medium rounded-full bg-cyan-100 text-water-dark hover:bg-cyan-200 transition">
                            <i data-lucide="home" class="w-4 h-4 mr-2"></i> Inicio
                        </button>
                        <button id="logout-button-orders" class="flex items-center px-4 py-2 text-sm font-medium rounded-full bg-red-100 text-red-700 hover:bg-red-200 transition">
                            <i data-lucide="log-out" class="w-4 h-4 mr-2"></i> Salir
                        </button>
                    </div>
                </header>

                <div class="p-6 max-w-7xl mx-auto w-full">
                    <!-- Control de Ventas del D√≠a -->
                    <div class="bg-water-primary text-white p-4 rounded-xl shadow-lg mb-6 flex justify-between items-center">
                        <div>
                            <i data-lucide="trending-up" class="w-6 h-6 inline mr-2"></i>
                            <span class="text-lg font-semibold">Ventas del D√≠a (${today}):</span>
                            <span class="text-3xl font-extrabold ml-4">Q.${todaySales}</span>
                        </div>
                        <div class="text-sm font-medium">
                            Total de Pedidos: ${todayOrders.length}
                        </div>
                    </div>

                    <!-- Tabla de Pedidos -->
                    <div class="bg-white rounded-xl shadow-lg overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fecha/Hora</th>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cliente/Tel</th>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tipo/Cant</th>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total</th>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Direcci√≥n</th>
                                    <th class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Entregado</th>
                                    <th class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">NIT</th>
                                    <th class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="orders-table-body" class="bg-white divide-y divide-gray-200">
                                <!-- Orders will be inserted here by updateOrdersTable() -->
                            </tbody>
                        </table>
                    </div>
                    <div id="loading-message-orders" class="text-center p-6 text-gray-500">Cargando pedidos en tiempo real...</div>
                </div>

                <!-- Modal de Edici√≥n (Oculto por defecto) -->
                <div id="edit-modal" class="fixed inset-0 bg-gray-600 bg-opacity-75 hidden z-50 flex items-center justify-center p-4">
                    <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-lg transform transition-all">
                        <h3 class="text-2xl font-bold text-water-dark mb-4">Editar Pedido</h3>
                        <form id="edit-form" class="space-y-4">
                            <input type="hidden" id="edit-id">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Nombre</label>
                                <input type="text" id="edit-customerName" required class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Tel√©fono</label>
                                <input type="tel" id="edit-phone" required class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Cantidad</label>
                                <input type="number" id="edit-quantity" min="1" max="9" required class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg">
                            </div>
                            <div id="edit-address-container" class="hidden">
                                <label class="block text-sm font-medium text-gray-700">Direcci√≥n</label>
                                <textarea id="edit-address" rows="2" class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg"></textarea>
                            </div>
                            <div class="flex justify-end space-x-3 mt-6">
                                <button type="button" id="close-modal-button" class="px-4 py-2 text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 transition">Cancelar</button>
                                <button type="submit" class="px-4 py-2 text-white bg-water-primary rounded-lg hover:bg-water-secondary transition">Guardar Cambios</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
        };

        // --- EVENT HANDLERS AND LOGIC ---
        window.attachEventListeners = () => {
            // 1. Login Screen
            const loginButton = document.getElementById('login-button');
            if (loginButton) {
                loginButton.onclick = window.handleLogin;
            }

            // 2. Home Screen
            const orderDomicilio = document.getElementById('order-domicilio');
            const orderFisica = document.getElementById('order-fisica');
            const viewOrdersButton = document.getElementById('view-orders-button');
            const logoutButton = document.getElementById('logout-button');

            if (orderDomicilio) orderDomicilio.onclick = () => window.handleOrderType('A DOMICILIO');
            if (orderFisica) orderFisica.onclick = () => window.handleOrderType('ENTREGA F√çSICA');
            if (viewOrdersButton) viewOrdersButton.onclick = () => window.renderApp('orders');
            if (logoutButton) logoutButton.onclick = window.handleLogout;

            // 3. Order Form Screen
            const orderForm = document.getElementById('order-form');
            const backHomeButton = document.getElementById('back-home-button');
            const quantityInput = document.getElementById('quantity');
            const phoneInput = document.getElementById('phone');

            if (orderForm) orderForm.onsubmit = window.handleFormSubmit;
            if (backHomeButton) backHomeButton.onclick = () => window.renderApp('home');
            if (quantityInput) quantityInput.oninput = window.updateTotal;
            // NEW: Add event listener for phone input change (autocompletion)
            if (phoneInput) {
                // Use 'blur' for when the user leaves the field, or 'input' for typing
                phoneInput.oninput = window.handlePhoneInput;
            }

            // 4. Orders List Screen
            const backHomeButtonOrders = document.getElementById('back-home-button-orders');
            const logoutButtonOrders = document.getElementById('logout-button-orders');
            const exportCsvButton = document.getElementById('export-csv-button');
            const ordersTableBody = document.getElementById('orders-table-body');
            const closeModalButton = document.getElementById('close-modal-button');
            const editForm = document.getElementById('edit-form');

            if (backHomeButtonOrders) backHomeButtonOrders.onclick = () => window.renderApp('home');
            if (logoutButtonOrders) logoutButtonOrders.onclick = window.handleLogout;
            if (exportCsvButton) exportCsvButton.onclick = window.exportToCSV;

            // Delegation for table actions (Edit/Delete/Delivered)
            if (ordersTableBody) {
                ordersTableBody.onclick = (e) => {
                    const target = e.target.closest('button, input[type="checkbox"]');
                    if (!target) return;

                    const id = target.dataset.id;

                    if (target.dataset.action === 'edit') {
                        window.openEditModal(id);
                    } else if (target.dataset.action === 'delete') {
                        window.deleteOrder(id);
                    } else if (target.type === 'checkbox') {
                        window.toggleDeliveredStatus(id, target.checked);
                    } else if (target.dataset.action === 'whatsapp') {
                        window.sendWhatsapp(id);
                    }
                };
            }

            // 5. Edit Modal
            if (closeModalButton) closeModalButton.onclick = window.closeEditModal;
            if (editForm) editForm.onsubmit = window.handleEditSubmit;
        };

        window.handleLogin = () => {
            const username = document.getElementById('username').value.trim().toUpperCase();
            const password = document.getElementById('password').value.trim();
            const errorDiv = document.getElementById('login-error');

            errorDiv.classList.add('hidden');

            if (CREDENTIALS[username] && CREDENTIALS[username] === password) {
                userRole = username; // Set application role
                window.renderApp('home');
            } else {
                errorDiv.textContent = 'Usuario o contrase√±a incorrectos.';
                errorDiv.classList.remove('hidden');
            }
        };

        window.handleLogout = () => {
            userRole = null;
            if (auth) {
                 signOut(auth).then(() => {
                    window.renderApp('login');
                }).catch(error => {
                    console.error("Error logging out:", error);
                    window.renderApp('login'); // Force login screen even on error
                });
            } else {
                // If auth is null, just reset state and render login
                window.renderApp('login');
            }
        };

        window.handleOrderType = (type) => {
            localStorage.setItem('currentOrderType', type);
            window.renderApp('form');
        };

        window.updateTotal = () => {
            const quantity = parseInt(document.getElementById('quantity').value) || 0;
            const type = localStorage.getItem('currentOrderType');
            const price = type === 'A DOMICILIO' ? PRECIO_DOMICILIO : PRECIO_FISICA;
            const total = (quantity * price).toFixed(2);
            document.getElementById('total-display').textContent = `Q.${total}`;
        };

        // --- NEW: Autocompletion Logic ---
        let autocompleteTimer;
        window.handlePhoneInput = (e) => {
            clearTimeout(autocompleteTimer);
            const phoneInput = e.target;
            const phone = sanitizePhone(phoneInput.value);
            const statusSpan = document.getElementById('autocomplete-status');

            if (phone.length < 7) { // Wait for a reasonable phone length (e.g., 7 digits)
                statusSpan.textContent = '';
                return;
            }

            statusSpan.innerHTML = '<i data-lucide="loader" class="w-4 h-4 animate-spin inline-block"></i> Buscando...';
            lucide.createIcons();

            autocompleteTimer = setTimeout(async () => {
                await window.autocompleteClientData(phone);
            }, 500); // Wait 500ms after user stops typing
        };

        window.autocompleteClientData = async (phone) => {
            const statusSpan = document.getElementById('autocomplete-status');
            const customerRef = doc(db, CUSTOMERS_COLLECTION, phone);

            try {
                const customerDoc = await new Promise((resolve, reject) => {
                    // Use onSnapshot for immediate real-time check, but resolve/reject after one call
                    const unsubscribe = onSnapshot(customerRef, (doc) => {
                        unsubscribe(); // Stop listening after the first snapshot
                        resolve(doc);
                    }, reject);
                });

                if (customerDoc.exists()) {
                    const data = customerDoc.data();
                    document.getElementById('customerName').value = data.customerName || '';
                    document.getElementById('nit').value = data.nit || '';
                    // Only autocomplete address if it's a Domicilio order
                    const currentType = localStorage.getItem('currentOrderType');
                    if (currentType === 'A DOMICILIO') {
                         document.getElementById('address').value = data.address || '';
                    }
                   
                    statusSpan.textContent = '¬°Cliente encontrado!';
                    statusSpan.classList.add('text-green-600');
                    statusSpan.classList.remove('text-gray-500', 'text-red-600');
                } else {
                    statusSpan.textContent = 'Cliente nuevo. Llenar datos.';
                    statusSpan.classList.add('text-red-600');
                    statusSpan.classList.remove('text-gray-500', 'text-green-600');
                    
                    // Clear fields if no client found
                    document.getElementById('customerName').value = '';
                    document.getElementById('nit').value = '';
                    if (localStorage.getItem('currentOrderType') === 'A DOMICILIO') {
                         document.getElementById('address').value = '';
                    }
                }
            } catch (error) {
                console.error("Error fetching customer data:", error);
                statusSpan.textContent = 'Error de b√∫squeda.';
                statusSpan.classList.add('text-red-600');
                statusSpan.classList.remove('text-gray-500', 'text-green-600');
            }
        };

        // --- NEW: Customer Update Logic ---
        window.updateCustomerDB = async (orderData) => {
            const phone = sanitizePhone(orderData.phone);
            const customerRef = doc(db, CUSTOMERS_COLLECTION, phone);

            // Data to be saved/updated in the customer database
            const customerData = {
                customerName: orderData.customerName,
                phone: orderData.phone,
                nit: orderData.nit,
                // Only save address if it was a Domicilio order
                address: orderData.orderType === 'A DOMICILIO' ? orderData.address : 'N/A',
                lastOrderDate: orderData.timestamp
            };

            try {
                // Use setDoc to create or overwrite the document with the phone as the ID
                await setDoc(customerRef, customerData, { merge: true });
                console.log("Customer data saved/updated successfully:", phone);
            } catch (e) {
                console.error("Error saving customer data: ", e);
            }
        };


        window.handleFormSubmit = async (e) => {
            e.preventDefault();

            const type = localStorage.getItem('currentOrderType');
            const isDomicilio = type === 'A DOMICILIO';
            const pricePerJug = isDomicilio ? PRECIO_DOMICILIO : PRECIO_FISICA;

            const name = document.getElementById('customerName').value.trim();
            const phone = document.getElementById('phone').value.trim();
            const quantity = parseInt(document.getElementById('quantity').value);
            const nit = document.getElementById('nit').value.trim() || 'C/F';
            const address = isDomicilio ? document.getElementById('address').value.trim() : 'N/A';
            const total = quantity * pricePerJug;
            const timestamp = new Date();

            const orderData = {
                customerName: name,
                phone: phone,
                quantity: quantity,
                nit: nit,
                address: address,
                orderType: type,
                pricePerJug: pricePerJug,
                total: total,
                timestamp: timestamp.getTime(), // Storing as Unix timestamp for sorting
                date: timestamp.toISOString().slice(0, 10),
                time: timestamp.toLocaleTimeString('es-GT'),
                isDelivered: false,
                orderedByUserId: userId,
                orderedByRole: userRole
            };

            const formMessage = document.getElementById('form-message');
            formMessage.classList.remove('hidden', 'bg-red-100', 'text-red-700');
            formMessage.classList.add('bg-cyan-100', 'text-water-dark');
            formMessage.innerHTML = 'Guardando pedido...';

            // --- Database Save Logic ---
            if (!isFirestoreAvailable) {
                console.warn("Firestore no est√° disponible debido a un error de conexi√≥n inicial. Pedido no guardado.");
                formMessage.classList.remove('bg-cyan-100', 'text-water-dark');
                formMessage.classList.add('bg-red-100', 'text-red-700');
                formMessage.textContent = '‚ùå Error: No se pudo conectar a Firebase. El pedido NO fue guardado.';
            } else {
                try {
                    // 1. Save Order
                    await addDoc(collection(db, ORDERS_COLLECTION), orderData);
                    
                    // 2. Save/Update Customer Info
                    await window.updateCustomerDB(orderData);


                    formMessage.innerHTML = `¬°Pedido de ${quantity} garrafones registrado con √©xito! Total: Q.${total.toFixed(2)}`;
                    document.getElementById('order-form').reset();
                    window.updateTotal(); // Reset total display

                } catch (e) {
                    console.error("Error adding document: ", e);
                    formMessage.classList.remove('bg-cyan-100', 'text-water-dark');
                    formMessage.classList.add('bg-red-100', 'text-red-700');
                    formMessage.textContent = 'Error al guardar el pedido. Verifica tus reglas de seguridad y conexi√≥n de Firebase.';
                    return;
                }
            }
            
            // Offer WhatsApp link
            if (isDomicilio) {
                const whatsappButton = `<button data-id="whatsapp-link" onclick="window.sendWhatsappLink('${name}', '${quantity}', '${total.toFixed(2)}', '${address}', '${phone}')" class="whatsapp-button w-full flex justify-center py-2 px-4 border border-transparent rounded-lg shadow-md text-lg font-bold text-white bg-green-500 hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition duration-150 ease-in-out mt-4">
                    <i data-lucide="message-circle" class="w-6 h-6 mr-2"></i> Enviar Confirmaci√≥n por WhatsApp
                </button>`;
                formMessage.innerHTML += whatsappButton;
                lucide.createIcons();
            }

            setTimeout(() => {
                // Reset form and message after a few seconds
                if (document.getElementById('order-form')) {
                     formMessage.classList.add('hidden');
                }
            }, 10000);
        };

        window.sendWhatsappLink = (name, quantity, total, address, phone) => {
            // Number formatting for WhatsApp link (Guatemala usually 8 digits, no country code needed for local link)
            // Use the provided phone number. If it contains symbols, remove them.
            const cleanPhone = phone.replace(/[^0-9]/g, '');

            const message = `¬°Hola ${name}! üëã\n\nTu pedido con AGUA CRISTAL ZONA 6 ha sido registrado y est√° en preparaci√≥n.\n\nüíß *Cantidad:* ${quantity} garraf√≥n(es).\nüíµ *Total:* Q.${total}.\nüó∫Ô∏è *Direcci√≥n Confirmada:* ${address}\n\nGracias por tu compra. ¬°Pronto estar√° contigo!`;
            const encodedMessage = encodeURIComponent(message);

            // Using the customer's phone number as the recipient
            const whatsappUrl = `https://wa.me/${cleanPhone}?text=${encodedMessage}`;

            window.open(whatsappUrl, '_blank');
        };

        window.setupRealtimeListener = () => {
            if (!isFirestoreAvailable) {
                console.warn("Firestore no disponible, se omiten listeners.");
                return;
            }

            const ordersQuery = query(collection(db, ORDERS_COLLECTION));

            onSnapshot(ordersQuery, (snapshot) => {
                const orders = [];
                snapshot.forEach((doc) => {
                    orders.push({ id: doc.id, ...doc.data() });
                });

                // Sort by timestamp descending
                orders.sort((a, b) => b.timestamp - a.timestamp);

                // Update global data (daily sales)
                window.updateDailyMetrics(orders);

            }, (error) => {
                console.error("Error listening to real-time data: ", error);
            });
        };

        window.updateDailyMetrics = (orders) => {
            const today = getTodayDate();
            let totalSales = 0;
            let filteredOrders = [];

            orders.forEach(order => {
                // Check if the order's date matches today
                if (order.date === today) {
                    totalSales += order.total;
                    filteredOrders.push(order);
                }
            });

            dailySales = totalSales;
            todayOrders = filteredOrders;

            // Re-render to update the sales display if in 'orders' view (Real-time updates)
            if (currentView === 'orders') {
                window.updateOrdersTable(todayOrders); // Pass the updated list
            }
        };

        window.updateOrdersTable = (orders) => {
            const tableBody = document.getElementById('orders-table-body');
            const loadingMessage = document.getElementById('loading-message-orders');
            const isAdmin = userRole === 'ADMINISTRADOR';

            if (!tableBody) return; // Not in the orders view

            let html = '';

            if (orders.length === 0) {
                // Modificado colspan a 8 para reflejar la nueva columna de Direcci√≥n
                html = `<tr><td colspan="8" class="text-center py-4 text-gray-500">No hay pedidos registrados hoy.</td></tr>`;
            } else {
                orders.forEach(order => {
                    const isDomicilio = order.orderType === 'A DOMICILIO';
                    const date = new Date(order.timestamp).toLocaleDateString('es-GT', {
                        day: '2-digit', month: 'short'
                    });
                    const time = new Date(order.timestamp).toLocaleTimeString('es-GT', {
                        hour: '2-digit', minute: '2-digit'
                    });

                    // Direcci√≥n: Mostrar solo para pedidos a domicilio, truncar si es muy larga.
                    const addressDisplay = isDomicilio 
                        ? (order.address.length > 30 ? order.address.substring(0, 30) + '...' : order.address)
                        : '<span class="text-gray-400">Entrega F√≠sica</span>';

                    html += `
                        <tr class="hover:bg-cyan-50 transition">
                            <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-800">
                                <strong>${date}</strong><br><span class="text-xs text-gray-500">${time}</span>
                            </td>
                            <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-800">
                                ${order.customerName}<br><span class="text-xs text-gray-500">${order.phone}</span>
                            </td>
                            <td class="px-3 py-2 whitespace-nowrap text-sm font-medium">
                                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${isDomicilio ? 'bg-cyan-100 text-cyan-800' : 'bg-green-100 text-green-800'}">
                                    ${order.orderType}
                                </span>
                                <br><span class="text-sm font-bold mt-1">${order.quantity} Garraf√≥n(es)</span>
                            </td>
                            <td class="px-3 py-2 whitespace-nowrap text-sm font-bold text-gray-800">Q.${order.total.toFixed(2)}</td>
                            <!-- COLUMNA DE DIRECCI√ìN -->
                            <td class="px-3 py-2 whitespace-normal text-sm text-gray-600">${addressDisplay}</td> 
                            <td class="px-3 py-2 whitespace-nowrap text-center">
                                ${isDomicilio ? `
                                    <input type="checkbox" data-id="${order.id}" ${order.isDelivered ? 'checked' : ''} ${isFirestoreAvailable ? '' : 'disabled'} class="h-5 w-5 text-water-primary border-gray-300 rounded focus:ring-water-primary cursor-pointer">
                                ` : `
                                    <span class="text-xs text-gray-400">N/A</span>
                                `}
                            </td>
                            <td class="px-3 py-2 whitespace-normal text-sm text-gray-500">${order.nit}</td>
                            <td class="px-3 py-2 whitespace-nowrap text-sm font-medium">
                                <div class="flex space-x-2 justify-center">
                                    ${isDomicilio ? `
                                        <button data-action="whatsapp" data-id="${order.id}" data-name="${order.customerName}" data-qty="${order.quantity}" data-total="${order.total.toFixed(2)}" data-addr="${order.address}" data-phone="${order.phone}" title="Enviar WhatsApp" class="text-green-500 hover:text-green-700 transition">
                                            <i data-lucide="message-circle" class="w-5 h-5"></i>
                                        </button>
                                    ` : ''}
                                    ${isAdmin ? `
                                        <button data-action="edit" data-id="${order.id}" title="Editar" ${isFirestoreAvailable ? '' : 'disabled'} class="text-water-primary hover:text-water-dark transition ${isFirestoreAvailable ? '' : 'opacity-50 cursor-not-allowed'}">
                                            <i data-lucide="pencil" class="w-5 h-5"></i>
                                        </button>
                                        <button data-action="delete" data-id="${order.id}" title="Eliminar" ${isFirestoreAvailable ? '' : 'disabled'} class="text-red-500 hover:text-red-700 transition ${isFirestoreAvailable ? '' : 'opacity-50 cursor-not-allowed'}">
                                            <i data-lucide="trash-2" class="w-5 h-5"></i>
                                        </button>
                                    ` : `
                                        <span class="text-gray-300 text-xs">Solo Admin</span>
                                    `}
                                </div>
                                <p class="text-xs text-center text-gray-400 mt-1 cursor-pointer" onclick="alert('Registrado por: ${order.orderedByRole}')">Ver Rol</p>
                            </td>
                        </tr>
                    `;
                });
            }

            tableBody.innerHTML = html;
            if (loadingMessage) loadingMessage.classList.add('hidden');
            lucide.createIcons();
        };

        window.toggleDeliveredStatus = async (id, isDelivered) => {
            // Permite que cualquier usuario logueado cambie el estado, solo bloqueado por fallos de DB
            if (!isFirestoreAvailable) {
                alert('Error: La base de datos no est√° disponible. No se puede actualizar el estado de entrega.');
                return;
            }

            const orderRef = doc(db, ORDERS_COLLECTION, id);
            try {
                // Se realiza la actualizaci√≥n
                await updateDoc(orderRef, { isDelivered: isDelivered });
            } catch (error) {
                console.error("Error updating delivered status:", error);
                alert('Error: No se pudo actualizar el estado de entrega. Revisa la conexi√≥n.');
            }
        };

        window.openEditModal = (id) => {
            if (!isFirestoreAvailable || userRole !== 'ADMINISTRADOR') return;
            const order = todayOrders.find(o => o.id === id);
            if (!order) return;

            document.getElementById('edit-id').value = order.id;
            document.getElementById('edit-customerName').value = order.customerName;
            document.getElementById('edit-phone').value = order.phone;
            document.getElementById('edit-quantity').value = order.quantity;

            const isDomicilio = order.orderType === 'A DOMICILIO';
            const addressContainer = document.getElementById('edit-address-container');
            const addressTextarea = document.getElementById('edit-address');

            if (isDomicilio) {
                addressContainer.classList.remove('hidden');
                addressTextarea.value = order.address;
            } else {
                addressContainer.classList.add('hidden');
                addressTextarea.value = '';
            }

            document.getElementById('edit-modal').classList.remove('hidden');
        };

        window.closeEditModal = () => {
            document.getElementById('edit-modal').classList.add('hidden');
        };

        window.handleEditSubmit = async (e) => {
            e.preventDefault();
            if (!isFirestoreAvailable || userRole !== 'ADMINISTRADOR') return;
            
            const id = document.getElementById('edit-id').value;
            const orderRef = doc(db, ORDERS_COLLECTION, id);

            const updatedName = document.getElementById('edit-customerName').value;
            const updatedPhone = document.getElementById('edit-phone').value;
            const updatedQuantity = parseInt(document.getElementById('edit-quantity').value);
            const updatedAddress = document.getElementById('edit-address').value;

            const currentOrder = todayOrders.find(o => o.id === id);
            if (!currentOrder) return;

            const price = currentOrder.pricePerJug;
            const newTotal = updatedQuantity * price;

            const updateData = {
                customerName: updatedName,
                phone: updatedPhone,
                quantity: updatedQuantity,
                total: newTotal,
            };

            if (currentOrder.orderType === 'A DOMICILIO') {
                updateData.address = updatedAddress;
            }

            try {
                // 1. Update Order
                await updateDoc(orderRef, updateData);

                // 2. Update Customer Info after order update
                const customerDataToUpdate = {
                    customerName: updatedName,
                    phone: updatedPhone,
                    nit: currentOrder.nit, // NIT is not in edit modal, so we reuse the old one
                    address: updatedAddress,
                    lastOrderDate: new Date().getTime()
                };
                await window.updateCustomerDB(customerDataToUpdate);


                window.closeEditModal();
            } catch (error) {
                console.error("Error updating order:", error);
                alert('Hubo un error al guardar los cambios.');
            }
        };

        window.deleteOrder = async (id) => {
            if (!isFirestoreAvailable || userRole !== 'ADMINISTRADOR') return;

            const confirmDelete = prompt('Escribe "ELIMINAR" para confirmar que quieres borrar este pedido:');
            if (confirmDelete !== 'ELIMINAR') return;

            const orderRef = doc(db, ORDERS_COLLECTION, id);
            try {
                await deleteDoc(orderRef);
            } catch (error) {
                console.error("Error deleting order:", error);
                alert('Hubo un error al eliminar el pedido.');
            }
        };

        window.exportToCSV = () => {
             // Use all todayOrders, regardless of DB availability
            if (todayOrders.length === 0) {
                alert("No hay pedidos para exportar.");
                return;
            }

            const headers = [
                'ID', 'Fecha', 'Hora', 'Nombre del Cliente', 'Tel√©fono', 'Cantidad', 'NIT', 'Tipo de Pedido', 'Precio Unitario (Q)', 'Total (Q)', 'Direcci√≥n', 'Entregado', 'Registrado por'
            ];
            const rows = todayOrders.map(order => [
                order.id,
                order.date,
                order.time,
                order.customerName,
                order.phone,
                order.quantity,
                order.nit,
                order.orderType,
                order.pricePerJug.toFixed(2),
                order.total.toFixed(2),
                `"${(order.address || 'N/A').replace(/"/g, '""')}"`, // Handle quotes in address
                order.isDelivered ? 'S√≠' : 'No',
                order.orderedByRole
            ]);

            let csvContent = headers.join(',') + '\n';
            rows.forEach(row => {
                csvContent += row.join(',') + '\n';
            });

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.setAttribute('href', url);
            a.setAttribute('download', `Pedidos_AGUA_CRISTAL_${getTodayDate()}.csv`);
            a.click();
            URL.revokeObjectURL(url);
        };

        window.getOrderByID = (id) => {
             // Fetches an order from the current day's list.
             return todayOrders.find(o => o.id === id);
        };

        // Initialize Firebase on window load
        window.onload = window.initFirebase;
    </script>

    <!-- Main App Container -->
    <div id="app-container" class="flex-grow flex flex-col">
        <div id="loading-screen" class="flex flex-col items-center justify-center flex-grow p-8">
            <div class="animate-spin rounded-full h-12 w-12 border-b-4 border-water-primary"></div>
            <p id="loading-message" class="mt-4 text-gray-600">Cargando aplicaci√≥n y conectando con la base de datos...</p>
        </div>
    </div>

</body>
</html>
